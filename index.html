<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdBlue</title>
</head>
<body style="padding:20px; text-align:center; font-family:sans-serif; background-color:#f5f5f5;">
    
    <div style="border:1px solid #ccc; border-radius:10px; padding:20px; background: white; max-width: 400px; margin: 0 auto;">
        <h2 style="color:#004a99; margin-top:0;">⛽ AdBlue</h2>
        
        <div id="vId" style="font-weight:bold; color: #555; margin-bottom: 15px; padding: 10px; background: #eef; border-radius: 5px;">
            Cargando vehículo...
        </div>

        <input type="number" id="litros" placeholder="Cantidad (Litros)" style="padding:15px; width:100%; box-sizing:border-box; font-size:16px; margin-bottom:15px; border: 1px solid #ddd; border-radius: 5px;">
        
        <button id="btn" style="padding:15px; background:#004a99; color:white; border:none; width:100%; font-size:16px; border-radius:5px; font-weight: bold; cursor: pointer;">
            GUARDAR REGISTRO
        </button>

        <p id="status" style="margin-top:15px; font-size:12px; color:grey;"></p>
    </div>

    <script>
        geotab.addin.adbluemanager = function (api, state) {
            
            // Función para envío directo (BYPASS)
            function sendDirectToGeotab(session, amount, deviceId, callback, errorCallback) {
                var xhr = new XMLHttpRequest();
                // Construimos la URL del servidor usando la sesión
                var url = "https://" + session.server + "/apiv1";
                
                xhr.open("POST", url, true);
                xhr.setRequestHeader("Content-Type", "application/json");

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            var resp = JSON.parse(xhr.responseText);
                            if (resp.error) {
                                errorCallback(resp.error.message);
                            } else {
                                callback(resp.result);
                            }
                        } else {
                            errorCallback("Error HTTP: " + xhr.status);
                        }
                    }
                };

                // Payload JSON-RPC manual
                var payload = {
                    method: "Add",
                    params: {
                        typeName: "MaintenanceRecord",
                        entity: {
                            device: { id: deviceId },
                            maintenanceType: { id: "KnownIdMaintenanceTypeOilChangeId" }, // Usamos cambio de aceite como placeholder fiable
                            notes: "Carga AdBlue: " + amount + "L",
                            dateTime: new Date().toISOString()
                        }
                    },
                    credentials: {
                        database: session.database,
                        sessionId: session.sessionId,
                        userName: session.userName
                    }
                };

                xhr.send(JSON.stringify(payload));
            }

            return {
                initialize: function (api, state, callback) {
                    const btn = document.getElementById('btn');
                    const vIdTxt = document.getElementById('vId');
                    const statusTxt = document.getElementById('status');
                    
                    // Detectar dispositivo
                    const device = state.device || state.activeDevice;
                    if (device) {
                        vIdTxt.innerText = "Vehículo: " + (device.name || device.id);
                        vIdTxt.style.color = "#004a99";
                    } else {
                        vIdTxt.innerText = "⚠️ Vehículo no detectado. (Abre desde el Menú)";
                        vIdTxt.style.color = "red";
                    }

                    btn.onclick = function() {
                        const val = document.getElementById('litros').value;
                        
                        if (!val) { alert("Por favor, introduce los litros."); return; }
                        if (!device) { alert("No se puede guardar: Vehículo no identificado."); return; }

                        btn.disabled = true;
                        btn.innerText = "Conectando...";
                        statusTxt.innerText = "Obteniendo sesión segura...";

                        // 1. Obtenemos la sesión real para poder hacer el bypass
                        api.getSession(function(session) {
                            statusTxt.innerText = "Enviando datos al servidor...";
                            
                            // 2. Usamos el bypass XHR
                            sendDirectToGeotab(session, val, device.id, function(res) {
                                alert("✅ ¡Guardado Correctamente!");
                                btn.innerText = "GUARDAR REGISTRO";
                                btn.disabled = false;
                                document.getElementById('litros').value = "";
                                statusTxt.innerText = "Registro ID: " + res;
                            }, function(err) {
                                console.error(err);
                                alert("❌ Error: " + err);
                                btn.innerText = "REINTENTAR";
                                btn.disabled = false;
                                statusTxt.innerText = "Fallo: " + err;
                            });

                        }, function(err) {
                            // Si falla getSession, intentamos el método antiguo como respaldo
                            console.log("Fallo getSession, probando api.call estándar...");
                            // ... (aquí iría el código antiguo, pero sabemos que falla) ...
                            alert("Error de sesión: " + err);
                            btn.disabled = false;
                        });
                    };
                    callback();
                },
                focus: function () {},
                blur: function () {}
            };
        };
    </script>
</body>
</html>
