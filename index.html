<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdBlue Tracker</title>
</head>
<body style="padding:20px; text-align:center; font-family:sans-serif; background-color:#f5f5f5;">
    
    <div style="border:1px solid #ccc; border-radius:10px; padding:20px; background: white; max-width: 400px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="color:#004a99; margin-top:0;">⛽ Carga AdBlue</h2>
        
        <div id="vId" style="font-weight:bold; color: #555; margin-bottom: 15px; padding: 10px; background: #eef; border-radius: 5px;">
            Detectando vehículo...
        </div>

        <input type="number" id="litros" placeholder="Litros (ej: 20)" style="padding:15px; width:100%; box-sizing:border-box; font-size:18px; margin-bottom:15px; border: 1px solid #ddd; border-radius: 5px; text-align: center;">
        
        <button id="btn" style="padding:15px; background:#004a99; color:white; border:none; width:100%; font-size:16px; border-radius:5px; font-weight: bold; cursor: pointer;">
            GUARDAR
        </button>

        <p id="status" style="margin-top:15px; font-size:12px; color:grey; min-height: 20px;"></p>
    </div>

    <script>
        geotab.addin.adbluemanager = function (api, state) {
            
            return {
                initialize: function (api, state, callback) {
                    const btn = document.getElementById('btn');
                    const vIdTxt = document.getElementById('vId');
                    const statusTxt = document.getElementById('status');
                    
                    // 1. Obtener el vehículo del estado (funciona en Dashboard y Menú)
                    const device = state.device || state.activeDevice;
                    
                    if (device) {
                        vIdTxt.innerText = "Vehículo: " + (device.name || device.id);
                        vIdTxt.style.color = "#004a99";
                    } else {
                        vIdTxt.innerText = "⚠️ Vehículo no detectado";
                        statusTxt.innerText = "Si estás en inicio, abre desde el menú 'Más'.";
                    }

                    btn.onclick = function() {
                        const val = document.getElementById('litros').value;
                        
                        if (!val) { alert("Introduce los litros"); return; }
                        if (!device) { alert("Error: Vehículo no identificado."); return; }

                        btn.disabled = true;
                        btn.innerText = "Conectando...";
                        statusTxt.innerText = "Obteniendo sesión...";

                        // 2. PEDIR CREDENCIALES AL SISTEMA (getSession)
                        api.getSession(function(session) {
                            statusTxt.innerText = "Creando túnel seguro...";
                            
                            // 3. CREAR UNA NUEVA CONEXIÓN "FULL ACCESS"
                            // Esto ignora el 'api' limitado de la App y crea uno nuevo directo al servidor
                            try {
                                const tunnelApi = new geotab.api(function (authCallback) {
                                    authCallback(session.userName, session.sessionId, session.database);
                                }, { 
                                    server: session.server, // Usar el servidor correcto (ej: my452.geotab.com)
                                    ssl: true 
                                });

                                statusTxt.innerText = "Enviando datos...";

                                // 4. ENVIAR DATOS POR EL TÚNEL
                                tunnelApi.call("Add", {
                                    typeName: "MaintenanceRecord",
                                    entity: {
                                        device: { id: device.id },
                                        maintenanceType: { id: "KnownIdMaintenanceTypeOilChangeId" }, // Usamos cambio de aceite como base
                                        notes: "AdBlue Carga: " + val + " Litros",
                                        dateTime: new Date().toISOString()
                                    }
                                }, function (result) {
                                    // ÉXITO
                                    alert("✅ ¡Guardado Correctamente!");
                                    btn.innerText = "GUARDAR";
                                    btn.disabled = false;
                                    document.getElementById('litros').value = "";
                                    statusTxt.innerText = "Registro ID: " + result;
                                }, function (error) {
                                    // ERROR
                                    console.error(error);
                                    alert("❌ Error al guardar: " + (error.message || error));
                                    statusTxt.innerText = "Fallo: " + error.message;
                                    btn.innerText = "REINTENTAR";
                                    btn.disabled = false;
                                });

                            } catch (e) {
                                alert("Error crítico creando conexión: " + e.message);
                                btn.disabled = false;
                            }

                        }, function(err) {
                            alert("No se pudo obtener la sesión: " + err);
                            btn.disabled = false;
                        });
                    };
                    callback();
                },
                focus: function () {},
                blur: function () {}
            };
        };
    </script>
</body>
</html>
