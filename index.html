geotab.addin.driveAppLink = function (api, state) {
    return {
        initialize: function (api, state, callback) {
            var consoleLog = document.getElementById('debug-console');
            var vehLabel = document.getElementById('vehiculo-label');
            var btn = document.getElementById('btn-guardar');
            
            var device = state.device || state.activeDevice;

            if (device) {
                vehLabel.innerHTML = "<b>Vehículo:</b> " + (device.name || device.id);
            }

            btn.onclick = function () {
                var litros = document.getElementById('litros-input').value;
                if (!litros || litros <= 0) { alert("Introduce litros."); return; }
                if (!device) { alert("No hay vehículo."); return; }

                btn.disabled = true;
                btn.innerText = "ACTUALIZANDO HISTORIAL...";

                // PASO 1: Leer lo que ya hay en comentarios
                api.call("Get", {
                    typeName: "Device",
                    search: { id: device.id }
                }, function (result) {
                    var deviceFull = result[0];
                    var historialPrevio = deviceFull.comment || "";
                    
                    // PASO 2: Crear la nueva entrada con fecha y hora
                    var fecha = new Date().toLocaleString('es-ES', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
                    var nuevaEntrada = "[" + fecha + " -> " + litros + "L]";
                    
                    // Unimos lo nuevo con lo viejo usando un separador claro
                    // Limitamos a 500 caracteres para no saturar el campo
                    var historialActualizado = (nuevaEntrada + "  |  " + historialPrevio).substring(0, 500);

                    // PASO 3: Guardar todo el bloque
                    api.call("Set", {
                        typeName: "Device",
                        entity: {
                            id: device.id,
                            comment: historialActualizado
                        }
                    }, function () {
                        consoleLog.innerText = "✅ Historial actualizado: " + nuevaEntrada;
                        alert("¡Repostaje añadido al historial!");
                        document.getElementById('litros-input').value = "";
                        btn.innerText = "ENVIAR REGISTRO";
                        btn.disabled = false;
                    }, function (err) {
                        alert("Error al guardar: " + err.message);
                        btn.disabled = false;
                    });

                }, function (err) {
                    alert("Error al consultar vehículo: " + err.message);
                    btn.disabled = false;
                });
            };

            callback();
        },
        focus: function () {},
        blur: function () {}
    };
};
