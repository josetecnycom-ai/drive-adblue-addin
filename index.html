<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro AdBlue</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background-color: #f4f7f9; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h3 { color: #004a99; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .info { background: #eef4fa; padding: 12px; border-radius: 6px; font-size: 0.9em; margin-bottom: 20px; border-left: 5px solid #004a99; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 15px; font-size: 18px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 20px; }
        button { width: 100%; padding: 15px; font-size: 16px; background: #004a99; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 1; transition: opacity 0.3s; }
        button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }
        #msg { margin-top: 15px; text-align: center; font-weight: bold; min-height: 20px; }
        .debug-info { margin-top: 30px; font-size: 10px; color: #666; background: #eee; padding: 10px; border-radius: 4px; word-break: break-all; }
    </style>
</head>
<body>

    <div class="card">
        <h3>⛽ Registro AdBlue</h3>
        
        <div id="vehicleInfo" class="info">
            ⏳ Detectando vehículo...
        </div>
        
        <label for="liters">Litros repostados:</label>
        <input type="number" id="liters" placeholder="Ej: 25.5" step="0.1" inputmode="decimal">
        
        <button id="saveBtn" disabled>ESPERANDO VEHÍCULO...</button>
        <p id="msg"></p>
    </div>

    <div id="debug" class="debug-info">Cargando v3.0...</div>

    <script>
        function logDebug(text) {
            const debugEl = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debugEl.innerHTML += `<div>[${time}] ${text}</div>`;
            console.log(text);
        }

        geotab.addin.registroAdblue = function (api, state) {
            
            const vehicleEl = document.getElementById('vehicleInfo');
            const saveBtn = document.getElementById('saveBtn');
            const msg = document.getElementById('msg');
            const litersInput = document.getElementById('liters');
            
            // Variable global para guardar el ID del vehículo detectado
            let currentDeviceId = null;

            return {
                initialize: function (api, state, callback) {
                    logDebug("Inicializando...");
                    
                    // 1. Detección del Dispositivo (PRIORIDAD AL ID)
                    // En DriveAppLink, state.device viene solo con ID: {id: "b137"}
                    if (state && state.device && state.device.id) {
                        handleDeviceFound(state.device.id, state.device.name, api);
                    } else if (state && state.activeDevice && state.activeDevice.id) {
                        handleDeviceFound(state.activeDevice.id, state.activeDevice.name, api);
                    } else {
                        logDebug("No hay ID en state.device. Buscando por API...");
                        fetchDeviceFromApi(api);
                    }

                    saveBtn.addEventListener('click', function() {
                        saveData(api);
                    });

                    callback();
                },

                focus: function (api, state) {
                    // Si cambia el contexto, actualizamos
                    if (state && state.device && state.device.id) {
                         // Solo actualizamos si el ID es diferente
                         if (state.device.id !== currentDeviceId) {
                             handleDeviceFound(state.device.id, state.device.name, api);
                         }
                    }
                }
            };

            // --- Funciones Lógicas ---

            function handleDeviceFound(id, name, api) {
                currentDeviceId = id;
                logDebug("ID detectado: " + id);
                
                // Habilitamos el botón INMEDIATAMENTE porque ya tenemos el ID necesario para guardar
                saveBtn.disabled = false;
                saveBtn.innerText = "ENVIAR REGISTRO";
                
                // Mostramos info temporal mientras buscamos el nombre real
                const displayName = name || "ID: " + id;
                vehicleEl.innerHTML = `<strong>Vehículo:</strong> ${displayName}<br><small>✅ Listo para registrar</small>`;
                vehicleEl.style.borderLeftColor = "green";

                // Si no tenemos el nombre (caso DriveAppLink), lo pedimos a la API para que quede bonito
                if (!name) {
                    api.call("Get", {
                        typeName: "Device",
                        search: { id: id }
                    }, function(results) {
                        if (results && results.length > 0) {
                            vehicleEl.innerHTML = `<strong>Vehículo:</strong> ${results[0].name}<br><small>ID: ${id}</small>`;
                        }
                    });
                }
            }

            function fetchDeviceFromApi(api) {
                // Fallback extremo si falla el state
                api.getSession(function(session) {
                    api.call("Get", {
                        typeName: "Device",
                        search: { fromDate: new Date().toISOString() },
                        resultsLimit: 1
                    }, function(devices) {
                        if (devices && devices.length > 0) {
                            handleDeviceFound(devices[0].id, devices[0].name, api);
                        } else {
                            vehicleEl.innerHTML = "❌ No se detecta vehículo.";
                            logDebug("API tampoco devolvió vehículos.");
                        }
                    });
                });
            }

            function saveData(api) {
                const liters = litersInput.value;
                if (!liters || liters <= 0) {
                    alert("Introduce los litros.");
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerText = "Enviando...";
                msg.innerText = "";

                const logRecord = {
                    typeName: "MaintenanceRecord",
                    entity: {
                        device: { id: currentDeviceId }, // Usamos el ID capturado
                        maintenanceType: { id: "KnownIdMaintenanceTypeOilChangeId" }, // ID Genérico de prueba
                        notes: "AdBlue Repostado: " + liters + " Litros",
                        dateTime: new Date().toISOString()
                    }
                };

                api.call("Add", logRecord, function(result) {
                    msg.style.color = "green";
                    msg.innerText = "✅ Guardado correctamente";
                    litersInput.value = "";
                    saveBtn.innerText = "ENVIAR OTRO";
                    saveBtn.disabled = false;
                }, function(err) {
                    msg.style.color = "red";
                    // Mostramos el error exacto en pantalla
                    msg.innerText = "❌ Error: " + (err.message || err.name || JSON.stringify(err));
                    console.error(err);
                    saveBtn.innerText = "REINTENTAR";
                    saveBtn.disabled = false;
                });
            }
        };
    </script>
</body>
</html>
