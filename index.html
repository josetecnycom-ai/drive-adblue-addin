<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>AdBlue Registro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 15px; background-color: #f4f4f4; text-align: center; }
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        h2 { color: #2c3e50; margin-top: 0; }
        .status-box { background: #e8f4fd; color: #00529b; padding: 10px; border-radius: 6px; margin: 15px 0; font-size: 14px; border-left: 5px solid #00529b; text-align: left;}
        input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 20px; }
        button { width: 100%; padding: 14px; background-color: #00529b; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #003d73; }
    </style>
</head>
<body>
    <div class="container">
        <h2>⛽ Registro AdBlue</h2>
        <div id="status" class="status-box">Inicializando sistema...</div>
        <input type="number" id="litros" placeholder="Ej: 20.5" step="0.1">
        <button id="btnEnviar" disabled>ESPERANDO CONEXIÓN...</button>
    </div>

    <script>
        // EL NOMBRE AQUÍ DEBE SER EXACTAMENTE EL MISMO QUE EN EL JSON: adblue_vFinal
        geotab.addin.adblue_vFinal = function (api, state) {
            
            return {
                initialize: function (api, state, callback) {
                    const statusDiv = document.getElementById('status');
                    const btn = document.getElementById('btnEnviar');
                    const input = document.getElementById('litros');
                    
                    // Intentamos obtener el dispositivo de varias fuentes posibles
                    const device = state.device || state.activeDevice || (state.pageState && state.pageState.device);

                    if (device && device.id) {
                        statusDiv.innerHTML = "✅ <strong>Vehículo Conectado</strong><br>ID: " + device.id + "<br>Nombre: " + (device.name || "Sin nombre");
                        btn.disabled = false;
                        btn.innerText = "GUARDAR REGISTRO";
                    } else {
                        statusDiv.innerHTML = "⚠️ <strong>Sin Vehículo</strong><br>No se detecta vehículo activo. Asegúrate de haber seleccionado uno en Drive.";
                        statusDiv.style.background = "#fff3cd";
                        statusDiv.style.color = "#856404";
                        statusDiv.style.borderColor = "#ffeeba";
                    }

                    btn.onclick = function() {
                        const litros = input.value;
                        if (!litros) {
                            alert("Por favor, introduce la cantidad de litros.");
                            return;
                        }

                        btn.disabled = true;
                        btn.innerText = "Guardando...";

                        api.call("Add", {
                            typeName: "MaintenanceRecord",
                            entity: {
                                device: { id: device.id },
                                maintenanceType: { id: "KnownIdMaintenanceTypeOilChangeId" }, // Usamos cambio de aceite como placeholder seguro
                                notes: "Carga AdBlue: " + litros + " Litros",
                                dateTime: new Date().toISOString()
                            }
                        }, function(result) {
                            alert("✅ Registro guardado correctamente en Geotab.");
                            input.value = "";
                            btn.disabled = false;
                            btn.innerText = "GUARDAR OTRO";
                        }, function(error) {
                            console.error("Error Geotab:", error);
                            alert("❌ Error al guardar: " + error.message);
                            btn.disabled = false;
                            btn.innerText = "REINTENTAR";
                        });
                    };

                    callback();
                },
                
                // Funciones requeridas para que el botón se mantenga en el Dashboard
                focus: function (api, state) {
                    console.log("Add-in visible");
                },
                blur: function (api, state) {
                    console.log("Add-in oculto");
                }
            };
        };
    </script>
</body>
</html>
