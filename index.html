<script>
geotab.addin.adblue_v3 = function (api, state) {

    return {

        initialize: function (api, state, callback) {

            const btn = document.getElementById('btn');
            const vInfo = document.getElementById('vInfo');

            api.getSession().then(session => {

                const deviceId = session.device.id;

                vInfo.innerText = "Vehículo: " + session.device.name;
                btn.disabled = false;
                btn.innerText = "GUARDAR REGISTRO";

                btn.onclick = function () {

                    const val = document.getElementById('litros').value;
                    if (!val) return;

                    btn.disabled = true;

                    api.call("Add", {
                        typeName: "MaintenanceRecord",
                        entity: {
                            device: { id: deviceId },
                            notes: "AdBlue: " + val + " L",
                            dateTime: new Date()
                        }
                    }).then(() => {
                        alert("¡Guardado correctamente!");
                        location.reload();
                    }).catch(err => {
                        alert("Error: " + err.message);
                        btn.disabled = false;
                    });

                };

                callback();
            });

        },

        focus: function () {},
        blur: function () {}

    };

};
</script>
