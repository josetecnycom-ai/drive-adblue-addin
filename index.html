geotab.addin.registroAdblue = function (api, state) {
    const vehicleEl = document.getElementById('vehicleInfo');
    const saveBtn = document.getElementById('saveBtn');
    const litersInput = document.getElementById('liters');
    const msgEl = document.getElementById('msg');
    let currentId = null;

    return {
        initialize: function (api, state, callback) {
            // Extraer ID del vehículo de las trazas de estado
            const device = state.device || state.activeDevice;
            if (device && device.id) {
                currentId = device.id;
                saveBtn.disabled = false;
                saveBtn.innerText = "ENVIAR REGISTRO";
                vehicleEl.innerHTML = `<strong>Vehículo detectado</strong><br>ID: ${currentId}`;
            }

            saveBtn.addEventListener('click', function() {
                const liters = litersInput.value;
                if (!liters || liters <= 0) return alert("Introduce litros");

                saveBtn.disabled = true;
                saveBtn.innerText = "⏳ Guardando...";

                // Usamos directamente el objeto api pasado por el constructor
                api.call("Add", {
                    typeName: "MaintenanceRecord",
                    entity: {
                        device: { id: currentId },
                        maintenanceType: { id: "KnownIdMaintenanceTypeOilChangeId" },
                        notes: "AdBlue: " + liters + "L",
                        dateTime: new Date().toISOString()
                    }
                }, function(result) {
                    msgEl.innerHTML = "✅ Guardado correctamente";
                    litersInput.value = "";
                    saveBtn.disabled = false;
                    saveBtn.innerText = "ENVIAR OTRO";
                }, function(err) {
                    // Si vuelve a salir 'method Add not found', es restricción del Path
                    alert("Error Geotab: " + (err.message || "Método Add restringido en este menú."));
                    saveBtn.disabled = false;
                    saveBtn.innerText = "REINTENTAR";
                });
            });
            callback();
        }
    };
};
