<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="padding:20px; text-align:center; font-family:sans-serif;">
    <div style="border:1px solid #ccc; border-radius:10px; padding:20px;">
        <h3>⛽ Registro AdBlue</h3>
        <p id="vId">Detectando vehículo...</p>
        <input type="number" id="litros" placeholder="Litros" style="padding:10px; width:80%;">
        <button id="btn" style="margin-top:10px; padding:10px; background:#004a99; color:white; border:none; width:85%;">GUARDAR</button>
    </div>

    <script>
        geotab.addin.adblue_sygic_v1 = function (api, state) {
            return {
                initialize: function (api, state, callback) {
                    const btn = document.getElementById('btn');
                    const vIdTxt = document.getElementById('vId');
                    const device = state.device || state.activeDevice;

                    if (device) vIdTxt.innerText = "Vehículo: " + (device.name || device.id);

                    btn.onclick = function() {
                        const val = document.getElementById('litros').value;
                        if (!device) return alert("Error: No se detecta vehículo.");

                        btn.disabled = true;
                        btn.innerText = "Enviando...";

                        // PASO 1: Obtenemos la llave de la sesión actual
                        api.getSession(function(session) {
                            // Construimos la dirección del servidor (ej. my.geotab.com/apiv1)
                            const serverUrl = 'https://' + session.server + '/apiv1';
                            
                            // PASO 2: Preparamos los datos manualmente (RPC JSON)
                            const payload = {
                                method: "Add",
                                params: {
                                    typeName: "MaintenanceRecord",
                                    entity: {
                                        device: { id: device.id },
                                        maintenanceType: { id: "KnownIdMaintenanceTypeOilChangeId" },
                                        notes: "AdBlue: " + val + "L",
                                        dateTime: new Date().toISOString()
                                    },
                                    credentials: {
                                        database: session.database,
                                        sessionId: session.sessionId,
                                        userName: session.userName
                                    }
                                }
                            };

                            // PASO 3: Enviamos directo al servidor (saltando el bloqueo de la App)
                            fetch(serverUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            })
                            .then(response => response.json())
                            .then(data => {
                                btn.disabled = false;
                                btn.innerText = "GUARDAR";
                                
                                if (data.error) {
                                    console.error("Error Geotab:", data.error);
                                    alert("Error del servidor: " + data.error.message);
                                } else {
                                    alert("¡Guardado correctamente! (ID: " + data.result + ")");
                                    document.getElementById('litros').value = "";
                                }
                            })
                            .catch(error => {
                                btn.disabled = false;
                                btn.innerText = "GUARDAR";
                                console.error("Error Red:", error);
                                alert("Error de conexión: " + error.message);
                            });
                        });
                    };
                    callback();
                },
                focus: function () {},
                blur: function () {}
            };
        };
    </script>
</body>
</html>
