<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdBlue Registro</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px; text-align: center; background-color: #f4f4f4;">

    <div style="background: white; max-width: 400px; margin: 0 auto; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h2 style="color: #004a99;">⛽ Carga AdBlue</h2>
        
        <div id="vehicle-info" style="margin-bottom: 15px; color: #555; font-weight: bold;">Detectando vehículo...</div>

        <input type="number" id="litros" placeholder="Litros (Ej: 20)" style="width: 100%; padding: 10px; font-size: 18px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px;">

        <button id="btn-save" style="width: 100%; padding: 15px; background-color: #004a99; color: white; border: none; font-size: 16px; font-weight: bold; border-radius: 5px; cursor: pointer;">
            GUARDAR REGISTRO
        </button>

        <div id="console-log" style="margin-top: 20px; font-size: 12px; color: #888; text-align: left; background: #eee; padding: 10px; border-radius: 5px; min-height: 40px; word-wrap: break-word;">
            Esperando acción...
        </div>
    </div>

    <script>
        // ¡IMPORTANTE! El nombre aquí AHORA coincide con tu JSON ("path": "DriveAppLink/")
        geotab.addin.driveAppLink = function (api, state) {
            
            return {
                initialize: function (api, state, callback) {
                    
                    var vehicleInfo = document.getElementById('vehicle-info');
                    var consoleLog = document.getElementById('console-log');
                    var btn = document.getElementById('btn-save');
                    
                    // 1. Obtener el vehículo actual
                    var device = state.device || state.activeDevice;
                    
                    if (device) {
                        vehicleInfo.innerText = "Vehículo: " + (device.name || device.id);
                        consoleLog.innerText = "Sistema listo. Vehículo detectado: " + device.id;
                    } else {
                        vehicleInfo.innerText = "⚠️ Vehículo no detectado";
                        consoleLog.innerText = "Error: No se detecta el ID del vehículo en el estado.";
                    }

                    // 2. Acción del botón
                    btn.onclick = function () {
                        var litros = document.getElementById('litros').value;
                        
                        if (!litros) {
                            alert("Por favor, introduce la cantidad de litros.");
                            return;
                        }

                        if (!device) {
                            alert("No se puede guardar: No hay vehículo identificado.");
                            return;
                        }

                        btn.disabled = true;
                        btn.innerText = "Guardando...";
                        consoleLog.innerText = "Enviando datos al servidor...";

                        // 3. Crear el objeto de ANOTACIÓN (Más sencillo que un mensaje)
                        var note = {
                            typeName: "Annotation",
                            entity: {
                                comment: "ADBLUE CARGADO: " + litros + " Litros",
                                dateTime: new Date().toISOString(),
                                device: { id: device.id }
                            }
                        };

                        // 4. Llamada a la API
                        api.call("Add", note, function (result) {
                            // Éxito
                            consoleLog.innerText = "✅ ÉXITO. ID de registro: " + result;
                            alert("¡Registro guardado correctamente!");
                            document.getElementById('litros').value = "";
                            btn.innerText = "GUARDAR REGISTRO";
                            btn.disabled = false;
                        }, function (error) {
                            // Error
                            consoleLog.innerText = "❌ ERROR: " + JSON.stringify(error);
                            alert("Error al guardar: " + error.message);
                            btn.innerText = "REINTENTAR";
                            btn.disabled = false;
                        });
                    };

                    callback();
                },

                focus: function (api, state) {
                    // Se ejecuta cuando el usuario vuelve a la pantalla
                    console.log("AdBlue Addin Focused");
                },

                blur: function (api, state) {
                    // Se ejecuta cuando el usuario sale
                    console.log("AdBlue Addin Blurred");
                }
            };
        };
    </script>
</body>
</html>
