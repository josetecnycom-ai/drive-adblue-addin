<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdBlue</title>
</head>
<body style="padding:10px; text-align:center; font-family:sans-serif; background:#f4f7f9;">
    <div style="background:white; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); max-width:350px; margin:auto;">
        <h2 style="color:#004a99; margin-bottom:5px;">⛽ Registro AdBlue</h2>
        <p id="vName" style="font-weight:bold; color:#666; font-size:14px; margin-bottom:20px;">Cargando vehículo...</p>

        <input type="number" id="litros" placeholder="Litros" style="width:80%; padding:15px; font-size:24px; border:2px solid #ddd; border-radius:8px; text-align:center; margin-bottom:15px;">
        
        <button id="btn" style="width:100%; padding:15px; background:#004a99; color:white; border:none; border-radius:8px; font-size:18px; font-weight:bold; cursor:pointer;">
            GUARDAR REGISTRO
        </button>

        <div id="debug" style="margin-top:20px; font-size:11px; color:#999; text-align:left; border-top:1px solid #eee; padding-top:10px; overflow-wrap: break-word;">
            Estado: Esperando...
        </div>
    </div>

    <script>
        // EL NOMBRE DEBE SER driveAppLink para que coincida con tu JSON
        geotab.addin.driveAppLink = function (api, state) {
            return {
                initialize: function (api, state, callback) {
                    const btn = document.getElementById('btn');
                    const debug = document.getElementById('debug');
                    const vName = document.getElementById('vName');
                    
                    // Detectar vehículo actual
                    const device = state.device || state.activeDevice;
                    if (device) {
                        vName.innerText = "Vehículo: " + (device.name || device.id);
                    }

                    btn.onclick = function() {
                        const val = document.getElementById('litros').value;
                        if (!val) { alert("Indica los litros"); return; }
                        
                        btn.disabled = true;
                        btn.innerText = "Guardando...";
                        debug.innerText = "Enviando anotación...";

                        // Usamos Annotation: es el método más flexible para notas rápidas
                        api.call("Add", {
                            typeName: "Annotation",
                            entity: {
                                comment: "CARGA ADBLUE: " + val + " Litros",
                                device: { id: device.id },
                                dateTime: new Date().toISOString()
                            }
                        }, function(result) {
                            debug.innerText = "✅ REGISTRADO: ID " + result;
                            alert("¡Guardado con éxito!");
                            document.getElementById('litros').value = "";
                            btn.disabled = false;
                            btn.innerText = "GUARDAR REGISTRO";
                        }, function(err) {
                            // Si falla, mostramos el error detallado para diagnosticar
                            debug.innerText = "❌ ERROR: " + (err.message || JSON.stringify(err));
                            btn.disabled = false;
                            btn.innerText = "REINTENTAR";
                        });
                    };
                    callback();
                }
            };
        };
    </script>
</body>
</html>
