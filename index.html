<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdBlue</title>
</head>
<body style="padding:10px; text-align:center; font-family:sans-serif; background:#f4f7f9;">
    <div style="background:white; border-radius:12px; padding:20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); max-width:350px; margin:auto;">
        <h2 style="color:#004a99; margin-bottom:5px;">⛽ Registro AdBlue</h2>
        <p id="vName" style="font-weight:bold; color:#666; font-size:14px; margin-bottom:20px;">Cargando vehículo...</p>

        <input type="number" id="litros" placeholder="Litros" style="width:80%; padding:15px; font-size:24px; border:2px solid #ddd; border-radius:8px; text-align:center; margin-bottom:15px;">
        
        <button id="btn" style="width:100%; padding:15px; background:#004a99; color:white; border:none; border-radius:8px; font-size:18px; font-weight:bold;">
            ENVIAR DATOS
        </button>

        <div id="debug" style="margin-top:20px; font-size:11px; color:#999; text-align:left; border-top:1px solid #eee; padding-top:10px; overflow-wrap: break-word;">
            Estado: Esperando...
        </div>
    </div>

    <script>
        geotab.addin.adbluemanager = function (api, state) {
            return {
                initialize: function (api, state, callback) {
                    const btn = document.getElementById('btn');
                    const debug = document.getElementById('debug');
                    const vName = document.getElementById('vName');
                    
                    // 1. Detectar vehículo
                    const device = state.device || state.activeDevice;
                    if (device) {
                        vName.innerText = "Vehículo: " + (device.name || device.id);
                        debug.innerText = "Estado: Listo para enviar.";
                    } else {
                        vName.innerText = "⚠️ No se detectó vehículo";
                        debug.innerText = "Error: Mueve el vehículo o reintenta.";
                    }

                    btn.onclick = function() {
                        const val = document.getElementById('litros').value;
                        if (!val) { alert("Pon los litros"); return; }
                        
                        btn.disabled = true;
                        btn.innerText = "Enviando...";
                        debug.innerText = "Estado: Intentando 'Add TextMessage'...";

                        // 2. Intentar enviar mensaje (El método más universal)
                        api.call("Add", {
                            typeName: "TextMessage",
                            entity: {
                                device: { id: device.id },
                                isDirectionToVehicle: false,
                                messageContent: "FORMULARIO_ADBLUE: " + val + " Litros",
                                dateTime: new Date().toISOString()
                            }
                        }, function(result) {
                            debug.innerText = "✅ ÉXITO: ID " + result;
                            alert("Guardado correctamente en Mensajería");
                            document.getElementById('litros').value = "";
                            btn.disabled = false;
                            btn.innerText = "ENVIAR DATOS";
                        }, function(err) {
                            debug.innerText = "❌ ERROR: " + JSON.stringify(err);
                            btn.disabled = false;
                            btn.innerText = "REINTENTAR";
                            console.error(err);
                        });
                    };
                    callback();
                }
            };
        };
    </script>
</body>
</html>
