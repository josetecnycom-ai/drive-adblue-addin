<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control AdBlue</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 500px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .info-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .info-card h3 {
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .info-card p {
            color: #4a5568;
            font-size: 16px;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group {
            position: relative;
        }

        .input-group span {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-weight: 600;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #e53e3e;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #3182ce;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history {
            margin-top: 30px;
            border-top: 2px solid #e2e8f0;
            padding-top: 20px;
        }

        .history h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .history-item {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #4a5568;
        }

        .history-item strong {
            color: #2d3748;
        }

        .debug-info {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            color: #742a2a;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>Cargando informaci贸n...</p>
        </div>

        <div id="main-content" style="display: none;">
            <div class="header">
                <h1> Control AdBlue</h1>
                <p>Registro de repostaje de AdBlue</p>
            </div>

            <div id="alert" class="alert"></div>

            <div class="info-card">
                <h3>Veh铆culo</h3>
                <p id="vehicle-name">-</p>
            </div>

            <div class="info-card">
                <h3>Conductor</h3>
                <p id="driver-name">-</p>
            </div>

            <form id="adblue-form">
                <div class="form-group">
                    <label for="adblue-quantity">Cantidad de AdBlue (Litros)</label>
                    <div class="input-group">
                        <input 
                            type="number" 
                            id="adblue-quantity" 
                            name="adblue-quantity"
                            min="0.1" 
                            step="0.1" 
                            required 
                            placeholder="Ej: 10.5"
                        >
                        <span>L</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="adblue-notes">Notas (Opcional)</label>
                    <input 
                        type="text" 
                        id="adblue-notes" 
                        name="adblue-notes"
                        placeholder="Ej: Repostaje en gasolinera X"
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="submit-btn">
                    Registrar AdBlue
                </button>
            </form>

            <div class="history" id="history-section" style="display: none;">
                <h3>ltimos registros</h3>
                <div id="history-list"></div>
            </div>

            <div id="debug-info" class="debug-info">
                <strong>Informaci贸n de debug:</strong>
                <div id="debug-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let api = null;
        let state = null;
        let currentDevice = null;
        let currentDriver = null;

        // Log para debug
        function debugLog(message, data) {
            console.log('[AdBlue]', message, data || '');
            const debugDiv = document.getElementById('debug-content');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<br>[${timestamp}] ${message}`;
                if (data) {
                    debugDiv.innerHTML += `: ${JSON.stringify(data)}`;
                }
            }
        }

        // Mostrar debug info (descomenta para activar)
        // document.getElementById('debug-info').classList.add('show');

        // Inicializaci贸n
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM cargado, esperando inicializaci贸n de Geotab');
        });

        // Funci贸n de inicializaci贸n de Geotab
        function geotabDriveAddInInit(freshApi, freshState, freshCallback) {
            debugLog('Geotab inicializado!');
            
            api = freshApi;
            state = freshState;

            debugLog('API disponible', { hasApi: !!api });
            debugLog('State disponible', state);

            // Cargar informaci贸n del veh铆culo y conductor
            loadVehicleAndDriverInfo();

            // Llamar al callback si existe
            if (typeof freshCallback === 'function') {
                freshCallback();
            }
        }

        // Cargar informaci贸n del veh铆culo y conductor
        async function loadVehicleAndDriverInfo() {
            try {
                showLoading(true);
                debugLog('Iniciando carga de informaci贸n');

                // Verificar que tenemos API
                if (!api) {
                    throw new Error('API no disponible');
                }

                // Obtener informaci贸n del dispositivo (veh铆culo)
                if (state && state.device && state.device.id) {
                    debugLog('Buscando dispositivo', { id: state.device.id });
                    
                    const devices = await api.call('Get', {
                        typeName: 'Device',
                        search: {
                            id: state.device.id
                        }
                    });

                    debugLog('Dispositivos encontrados', { count: devices ? devices.length : 0 });

                    if (devices && devices.length > 0) {
                        currentDevice = devices[0];
                        const vehicleName = currentDevice.name || currentDevice.serialNumber || 'N/A';
                        document.getElementById('vehicle-name').textContent = vehicleName;
                        debugLog('Veh铆culo establecido', { name: vehicleName });
                    }
                } else {
                    debugLog('No hay informaci贸n de dispositivo en state');
                    document.getElementById('vehicle-name').textContent = 'No disponible';
                }

                // Obtener informaci贸n del conductor
                if (state && state.driver && state.driver.id) {
                    debugLog('Buscando conductor', { id: state.driver.id });
                    
                    const drivers = await api.call('Get', {
                        typeName: 'User',
                        search: {
                            id: state.driver.id
                        }
                    });

                    debugLog('Conductores encontrados', { count: drivers ? drivers.length : 0 });

                    if (drivers && drivers.length > 0) {
                        currentDriver = drivers[0];
                        const driverName = `${currentDriver.firstName || ''} ${currentDriver.lastName || ''}`.trim() 
                            || currentDriver.name || 'N/A';
                        document.getElementById('driver-name').textContent = driverName;
                        debugLog('Conductor establecido', { name: driverName });
                    }
                } else {
                    debugLog('No hay informaci贸n de conductor en state');
                    document.getElementById('driver-name').textContent = 'No disponible';
                }

                // Cargar historial
                await loadHistory();

                showLoading(false);

            } catch (error) {
                debugLog('Error cargando informaci贸n', error.message);
                console.error('Error loading info:', error);
                showAlert('Error al cargar la informaci贸n: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Cargar historial de registros
        async function loadHistory() {
            try {
                if (!currentDevice) {
                    debugLog('No hay dispositivo para cargar historial');
                    return;
                }

                debugLog('Cargando historial');

                // Buscar registros de AdBlue de los 煤ltimos 30 d铆as
                const fromDate = new Date();
                fromDate.setDate(fromDate.getDate() - 30);

                const textMessages = await api.call('Get', {
                    typeName: 'TextMessage',
                    search: {
                        deviceSearch: {
                            id: currentDevice.id
                        },
                        fromDate: fromDate.toISOString()
                    }
                });

                debugLog('Mensajes encontrados', { count: textMessages ? textMessages.length : 0 });

                // Filtrar solo mensajes de AdBlue
                const adblueMessages = textMessages.filter(msg => 
                    msg.message && msg.message.includes('AdBlue:')
                ).slice(0, 5); // ltimos 5 registros

                if (adblueMessages.length > 0) {
                    const historyList = document.getElementById('history-list');
                    historyList.innerHTML = '';

                    adblueMessages.forEach(msg => {
                        const item = document.createElement('div');
                        item.className = 'history-item';
                        const date = new Date(msg.dateTime);
                        item.innerHTML = `
                            <strong>${date.toLocaleDateString('es-ES')}</strong> - 
                            ${msg.message}
                        `;
                        historyList.appendChild(item);
                    });

                    document.getElementById('history-section').style.display = 'block';
                    debugLog('Historial cargado', { items: adblueMessages.length });
                }

            } catch (error) {
                debugLog('Error cargando historial', error.message);
                console.error('Error loading history:', error);
            }
        }

        // Manejar env铆o del formulario
        document.getElementById('adblue-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const quantity = parseFloat(document.getElementById('adblue-quantity').value);
            const notes = document.getElementById('adblue-notes').value;

            debugLog('Formulario enviado', { quantity, notes });

            if (!quantity || quantity <= 0) {
                showAlert('Por favor, ingresa una cantidad v谩lida de AdBlue.', 'error');
                return;
            }

            if (!currentDevice) {
                showAlert('No se pudo obtener la informaci贸n del veh铆culo.', 'error');
                debugLog('Error: No hay dispositivo actual');
                return;
            }

            if (!currentDriver) {
                showAlert('No se pudo obtener la informaci贸n del conductor.', 'error');
                debugLog('Error: No hay conductor actual');
                return;
            }

            try {
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registrando...';

                debugLog('Creando registro de AdBlue');

                // Crear mensaje personalizado
                const messageText = `AdBlue: ${quantity}L${notes ? ' - ' + notes : ''}`;

                // Registrar en MyGeotab usando TextMessage
                const textMessage = {
                    device: { id: currentDevice.id },
                    messageContent: {
                        message: messageText,
                        contentType: 'Normal'
                    },
                    isDirectionToVehicle: false,
                    user: { id: currentDriver.id },
                    activeFrom: new Date().toISOString(),
                    activeTo: new Date().toISOString()
                };

                debugLog('Enviando TextMessage', textMessage);

                await api.call('Add', {
                    typeName: 'TextMessage',
                    entity: textMessage
                });

                debugLog('TextMessage creado exitosamente');

                // Tambi茅n crear un CustomData para mejor trazabilidad
                try {
                    const customData = {
                        device: { id: currentDevice.id },
                        dateTime: new Date().toISOString(),
                        data: JSON.stringify({
                            type: 'adblue_refill',
                            quantity: quantity,
                            unit: 'liters',
                            notes: notes,
                            driverId: currentDriver.id,
                            driverName: `${currentDriver.firstName || ''} ${currentDriver.lastName || ''}`.trim(),
                            vehicleName: currentDevice.name
                        })
                    };

                    debugLog('Enviando CustomData', customData);

                    await api.call('Add', {
                        typeName: 'CustomData',
                        entity: customData
                    });

                    debugLog('CustomData creado exitosamente');
                } catch (customDataError) {
                    debugLog('CustomData no disponible o error', customDataError.message);
                    console.warn('CustomData not available or error:', customDataError);
                }

                showAlert(`隆Registro exitoso! ${quantity}L de AdBlue registrados correctamente.`, 'success');

                // Limpiar formulario
                document.getElementById('adblue-quantity').value = '';
                document.getElementById('adblue-notes').value = '';

                // Recargar historial
                await loadHistory();

            } catch (error) {
                debugLog('Error guardando registro', error.message);
                console.error('Error saving AdBlue record:', error);
                showAlert('Error al registrar el AdBlue: ' + error.message, 'error');
            } finally {
                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar AdBlue';
            }
        });

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('main-content').style.display = show ? 'none' : 'block';
        }

        // Mostrar alertas
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type} show`;

            setTimeout(() => {
                alertDiv.classList.remove('show');
            }, 5000);
        }

        // Funci贸n global para compatibilidad con MyGeotab
        window.geotabDriveAddInInit = geotabDriveAddInInit;

        debugLog('Script cargado completamente');
    </script>
</body>
</html>
